说男凸膜涡陇郡 ..判明。\断ツ`ル「 PoshC2」を .する攻膜瘟鳏欷蚪庹h

lac.co.jp/lacwatch/people/20200424_002177.html 


サイバ`救急センタ`の.川です。 2019年2.にLAC WATCHで、ペネトレ`ションテストツ`ル「 PoshC2」を.した说男凸膜..をB介しました。 
LAC WATCH：オ`プンソ`スのツ`ル「 
PoshC2」を.した新たな说男凸膜虼_J 

2020年に.ってからも、私の所属する{威分析チ`ムでは同Nの攻膜蛞きAきQyしており、今まで_Jできなかったな攻膜瘟鳏欷 .えてきました。攻恼撺哎氅`プが .いる攻膜. .やC2インフラに浠がFれていることも_Jしています。
今回は、新たに .えてきたな攻膜..と、背後に潜む攻恼撺哎氅`プについてB介します。 
PoshC2を.した说男凸膜卧な.. 
1は、 PoshC2を.する攻膜瘟鳏欷蚴兢筏郡猡韦恰 .きく 3つの ..に分されます。このうち、攻..2については前述の2019年2.に公_した 
LAC 
WATCH事で取り上げているため、ここでは攻..1と攻..3のと、攻膜沃肖鞘工铯欷 C2インフラの浠についてh明します。

1 PoshC2を.する 3つの攻..の概要
攻..1（CVE-2019-9489およびDLLハイジャックの.）
これは、ウイルスバスタ`Corp.の脆弱性（CVE-2019-9489）および DLLハイジャック（DLL Search Order Hijacking）を.した攻..です。 2019年のLAC WATCH事では、 DLLハイジャックの.から PoshC2スクリプトのg.までを解hしましたが、今回は、被害者PCへの不正なDLLファイルの配信.法とDLLハイジャックの.についてです。攻膜味啶は、今年1.に_催された Japan Security Analyst Conference 2020での JPCERTコ`ディネ`ションセンタ`のk表でもB介された ※1、CVE-2019-9489の脆弱性の.から始まります。2は、 CVE-2019-9489および DLLハイジャックを.した ..の概要です。 
※1 
Japan 
Security 
Analyst 
Conference 
2020 
(オ`プニングト`ク) 
2019年のインシデントを振り返る

2 CVE-2019-9489および DLLハイジャックを.した ..の概要
攻膜瘟鳏欷洗韦瓮à辘扦埂 
1.
攻恼撙稀スピアフィッシングメ`ルや脆弱性の.等によって侵害した PCを踏み台として、 CVE-2019-9489の脆弱性を.し、ウイルスバスタ`Corp.サ`バの特定のディレクトリに管理者叵蓼虺证恼J^ト`クンファイルを作成 

2.
攻恼撙稀このト`クンを利.してウイルスバスタ`Corp.サ`バの管理画 .のJ^を回避し、管理者叵蓼钎クセス。その後、パタ`ンファイルの配信元を、攻恼撙管理する韦违ップデ`トサ`バへO定涓 

3.
韦违ップデ`トサ`バから、不正な「 dbghelp.dll」ファイルを含む韦违靴咯`ンファイルが被害者PCに配信される。このH、ウイルスバスタ`Corp.クラインアントがパタ`ンファイルの内容をm切に试^しない ※2ため、 DLLファイルが被害者PCの特定のディレクトリに展_される 

4.
ウイルスバスタ`Corp.クラインアントのプログラムがg.されるHに、「%SystemRoot%￥System32」にある正の「 dbghelp.dll※3」ではなく、同じディレクトリに展_された不正な「 dbghelp.dll」を意恧护赫iみzんでしまい、 DLLファイルに含まれたいくつかの攻磨畅`ド※4がBATファイルを通じてg.される


攻膜沃肖翘栅る.についてピックアップしてみていきます。
※2この}については、ウイルスバスタ`Corp. XG SP1の龊稀CVE-2019-9489の脆弱性を解消するパッチ（Critical Patch 5338）の1つ前にリリ`スされた Critical Patch 5294で解消されていることを_Jしています。 
※3 Microsoftのデバックエンジンを提供する DLLファイルの 1つです。 
※4 PoshC2スクリプト、リモ`トデスクトップのネット`クレベルJ^（NLA）のo炕、ログイン画.の.R（magify.exe）を「 cmd.exe」に置きQえたバックドアの作成や管理者叵蓼蛴肖工毳姗`ザを作成するコマンドなどの攻磨畅`ド。 
CVE-2019-9489の脆弱性
CVE-2019-9489はディレクトリトラバ`サルが可能な脆弱性です。ウイルスバスタ`Corp.クライアントから隔xファイルを受信するプログラム「 cgiRecvFile.exe」が、特定のv数において . .されたファイルパスをm切にチェックしないことに起因しています。攻恼撙悉长未嗳跣预 .することによって、ウイルスバスタ`Corp.サ`バまたはウイルスバスタ`ビジネスセキュリティサ`バで任意のファイルを作成.涓することができます。
3は、この脆弱性が修正されたウイルスバスタ`ビジネスセキュリティ 9.5 Critical Patch（ビルド 1487）のReadme※5の内容の.部iです。 .で示すように、「 cgiRecvFile.exe」で脆弱性が修正されていることが_Jできます。その他のウイルスバスタ`Corp.の修正プログラムについては、トレンドマイクロ社のサポ`ト情蟆6をご参照ください。

3ウイルスバスタ`ビジネスセキュリティ 9.5 Critical Patch（ビルド 1487）.部i 
※5 http://.les.trendmicro.com/jp/ucmodule/vbbiz/95/patch/cp1487/readme_biz95_win_CriticalPatch_ 
B1487.txt 

※6サポ`ト情 
:トレンドマイクロ【注意酒稹勘咨缪u品の脆弱性 
(CVE-2019-9489)を.した攻膜蜓}数_Jしたことによる最新修正プログラムm.のおい
.Rを.したバックドアと、リモ`トデスクトップのネット`クレベルJ^のo炕
「dbghelp.dll」に含まれる BATファイルには、4のようなレジストリを涓するコマンドが含まれています。これらのコマンドは、.R（magnify.exe）を.した「 cmd.exe」によるバックドアをO定するものと、リモ`トデスクトップのネット`クレベルJ^（NLA）をo炕するものです。また、5は、ログイン画.から.Rを.したバックドアをg.したものです。 .で示すように SYSTEM叵蓼恰 cmd.exe」が起婴筏皮い毪长趣_Jできます。

4.Rを涓するコマンド（上）／リモ`トデスクトップのネット`クレベルJ^のo炕するコマンド（下）

5ログイン画.から.Rのg. 
DLLハイジャック
DLLハイジャックは、 DLLファイルをiみzむHの仕鳐靴工I理に起因して、同.ディレクトリに存在する特定のDLLファイルをiみzんでしまう}です。攻膜瘟鳏欷钦h明したように、攻恼撙稀ウイルスバスタ`Corp.サ`バのアップデ`ト配信C能を.し、被害者PCのウイルスバスタ`Corp.クライアントの特定のディレクトリに攻磨畅`ドを含む「 dbghelp.dll」を展_させます。ウイルスバスタ`Corp.クライアントのプログラムが幼鳏筏侩Hに、「%SystemRoot%￥System32」にある正の「 dbghelp.dll」ではなく、特定のディレクトリに展_された不正なDLLファイルがiみzまれて攻磨畅`ドがg.されます。表1は、このアップデ`ト配信C能を.した攻膜.可能なウイルスバスタ`Corp.クライアントのプログラムの .例で、いずれも PC起rに.g.されます
表1 DLLハイジャック可能なプログラム
プログラ_Jバ`ジム名ョン※7h明 
PccNT\13.0.0.1361ウイルスバスタ`Corp.クライアントモニタ`のプロセ Mon.exeス
NTRt\13.0.0.1361リアルタイムスキャンのプロセス Scan.exe 
TmLis\13.0.0.1361ウイルスバスタ`Corp.クライアントがウイルスバスタ 
ten.exe`Corp.サ`バと通信するためのプロセス 
※7ウイルスバスタ`Corp. XG SP1の龊稀Critical Patch 5294以降のパッチをm.したバ`ジョンを利.することで、この攻膜摔瑜胗绊を和することが可能です。
6は、「 PccNTMon.exe」によってiみzまれたファイルを Process Monitorで_Jしたものです。「 dbghelp.dll」がシステムディレクトリ（%SystemRoot%￥system32）ではなく、トレンドマイクロ社u品のディレクトリ（C:￥Program Files￥Trend Micro￥Of.ceScan Client）からiみzまれてしまっていることが_Jできます。

6「PccNTMon.exe」によるiみzまれたファイルi（Process Monitor）
7は、「 PccNTMon.exe」によってiみzまれた DLLファイルを Process Explorerで_Jしたものです。こちらでも、「 dbghelp.dll」が「 C:￥Program Files￥Trend Micro￥Of.ceScan Client」からiみzまれていることが_Jできます。また、 .で示すように、「 dbghelp.dll」に含まれた「.refox.exe」（PowerShell）がPoshC2スクリプトをg.していることも_Jできます。

7「PccNTMon.exe」によるiみzまれた DLLファイルi（Process Explore）
カスタム PoshC2 
攻恼撙稀⒐_されている PoshC2の「 Core Dropper」のコ`ド※8にセキュリティ制限を回避するコ`ドをいくつか加え、攻膜死.しています。ここでは、加えられた 3つのコ`ドについてB介します。 
※8 
Core 
Dropper 
--PoshC2 
Framework 
documentation 

1つ.は、 Antimalware Scan Interface（AMSI）※9を回避するコ`ドです（8）。これはg.するh境がWindows 10の龊悉幼鳏筏蓼埂 AMSIは、 Windows 10から胜谴钶dされているマルウェア策.のインタ`フェ`スで、意のあるスクリプトを食訾工胧私Mみを提供します。しかし、 Windows 10バ`ジョン1903では、 Windows Defenderによってブロックされていることが_Jできます（9）。 
※9 
Antimalware 
Scan 
Interface 
(AMSI) 
-Win32 
apps 
| 
Microsoft 
Docs 


8 AMSIを回避するコ`ド

9 Windows Defenderによる AMSI回避コ`ドをg.rのブロック状r（Windows 10バ`ジョン1903） 
2つ.は、 PowerShellスクリプトブロックのログhをo郡摔工毳畅`ドです（10）。こちらもg.するh境がWindows 10の龊悉幼鳏筏蓼埂 Windows 10など PowerShell v5.0がインスト`ルされたh境では、g.された PowerShellスクリプトがデフォルトでイベントログにhされますが、攻恼撙悉长沃葡蓼蚧乇埭贰⒐膜魏圹Eをhさせない ..を.いています。

10 PowerShellスクリプトブロックのログhをo郡摔工毳畅`ド
最後の3つ.のコ`ドは、 PoshC2のg.rgを指定するコ`ド（11）で、 OSのバ`ジョンにvわらずg.されます。g.rgはスクリプトによってもなりますが、平均的な勤め.の勤rgを.安とした 8:00から 21:00ごろまで婴ようにO定されています。

11g.rgを制限するコ`ド
攻..3（MSBuildの.）
これは Microsoft Build Engine（MSBuild）※10を.した攻..です。 .NET Frameworkラインタイムに胜呛まれる MSBuildは、 Visual Studioや.NET Frameworkのビルドエンジンであり、独.のXMLフォ`マットファイル（プロジェクトファイル）を利.して .NETアプリケ`ションを作成できます。 PoshC2は、 EXE、DLL、BAT、JSなど々なフォ`マット ※11でペイロ`ドを作成でき、そのうちの 1つにこの MSBuildで利.可能なXMLファイルがあります。 
※10 
MSBuild 
-Visual 
Studio 
| 
Microsoft 
Docs 

※11 
PoshC2/resources/payload-templates 
at 
master 
・ 
nettitude/PoshC2 
・ 
GitHub
12は、 PoshC2によって作成された XMLファイルの .部コ`ドです。 .で欷螭啦糠证攻磨畅`ドであり、 sc32が32bith境.で、 sc64が64bith境.です。この攻磨畅`ドには、シェルコ`ド、 PoshC2スクリプトを含むDLLファイル（PowershellDLL.dll）と.NETアプリケ`ション（Microsoft.dll）の3つが含まれています。13は、攻磨畅`ドを Base64デコ`ドしたものであり、先^から 0x364バイトまでがシェルコ`ド（.）に当し、その後に「 MZ」ヘッダが消された DLLファイルが含まれていることが_Jできます。

12 PoshC2で作成した攻磨畅`ドを含むMSBuild.のプロジェクトファイル（.部i）

13 Base64デコ`ド後の32ビット .の攻磨畅`ド（.部i）
「MZ」ヘッダが消された DLLファイルには、 Base64とgzipでエンコ`ドおよびRsされた PoshC2スクリプトが含まれています（14）。この PoshC2スクリプトは、攻磨畅`ドの 3つ.に含まれる .NETアプリケ`ションによってメモリ上でg.され、「 MSBuild.exe」プロセスにインジェクションして幼鳏筏蓼埂 .NETアプリケ`ションは「 PowerShellRunner」※12をカスタマイズしたものであり、 PowerShellのC能を提供する「 System.Management.Automation.dll」を利 .することで、「 powershell.exe」を呼び出さず、 PowerShellスクリプトをg.します（ 15）。 
※12 
UnmanagedPowerShell/PowerShellRunner 
at 
master 
・ 
leechristensen/UnmanagedPowerShell 
・ 
GitHub 


14 DLLファイルに含まれた Base64でエンコ`ドされた PoshC2コ`ド（.部i）

15 PowerShellRunnerのPowerShellスクリプトg.コ`ド（.部i） 
C2インフラを定期的に涓
攻恼撙稀 2019年前半までは、 GCP（Google Cloud Platform）やMicrosoft Azureといったクラウドサ`ビスを主要なC2サ`バとして.していました。 2019年後半からは、 .港でVPSサ`ビスを提供する Shenzhen Katherine Heng Technology Information（AS135357）やCloudie Limited（AS55933）が.されています。攻恼撙稀 C2インフラを再利 .せず、定期的に涓して攻幕婴.なっています。


背後に潜む攻恼撺哎氅`プ
私たちは PoshC2を.した .Bの攻膜摔膜い普{べる中で、 .本や台湾を主な说膜趣工牍恼撺哎氅`プTaidoor※13やBlackTechが、この .Bの攻膜碎v与している可能性があることを示す痕Eを_Jしています。 
※13攻磨ャンペ`ン名として使われている龊悉猡ります。 
Taidoor 
トレンドマイクロ社のブログ ※14、NTT Security社のレポ`ト※15やTaidoorが利.するマルウェア（SERKDES）の解析レポ`ト※16で蟾妞丹欷皮い牍膜..と以下の点が似します。 

2018年.2019年における .本への说男凸膜扦巍 PoshC2」の. 

Remote Access Auto Connection Manager（RasAuto）サ`ビスを.した .悠釉O定（16）


オンラインストレ`ジサ`ビスである「 Dropbox」の利. 

※14
この 
.型B休前後に法.で注意すべき说男凸膜翁栅蚪庹h 
|トレンドマイクロセキュリティブログ说男凸磨ャンペ`ン「Taidoor」の活婴.本で活k化 
|トレンドマイクロセキュリティブログ 

※15 
taidoorを.いた说男凸慕馕謦欹荸`ト_v1 


※16 
BKDR_SERKDES.A 
-{威デ`タベ`ス



16 RasAutoサ`ビスを.した PoweShellの.g.登h例 
BlackTech 
PoshC2を.する .Bの攻膜沃肖恰 BlackTechが利.する TSCookieやTSCookie Loader※17を_Jしています。17に示すように、 TSCookie Loaderがiみzむファイルは、「 *%c???.*」にマッチするファイル名です。今回のケ`スでは、 "%c"には、「 A」が .るため、ファイル名が「*A??.*」となっています。また、メモリ上にロ`ドされる DLLファイル名は、正のDLLファイル名と同じ「 gdiplus.dll」となっています（18）。 
※17攻磨哎氅`プBlackTechが侵.後に使.するマルウエア 
-JPCERT/CC 
Eyes 
| 
JPCERTコ`ディネ`ションセンタ`公式ブログ

17 TSCookie Loaderがiみzむファイル名
これらの 2つの攻恼撺哎氅`プの痕Eは同.Mの侵害事例の中で.つかっています。被害者PCに残されたマルウェア、イベントログや通信ログなどの痕Eを_Jすると、同.期gに作成されたものではなく、いずれかの攻膜.われた後、数ヶ.から半年ほどUってから、新たに作成されたものでした。このことから、 2つの攻恼撺哎氅`プは、「说慕Mの情蟆工蚬灿肖贰⑦B携しながら攻幕婴.っている、または 1つの .きな攻恼撺哎氅`プとして攻幕婴.なっている可能性が考えられます。今回は、 2020年においても PoshC2を.した攻膜蛞きAき_Jしているため、この .Bの攻膜摔膜い聘膜幛平B介しました。昨今、Taidoorや BlackTechは、~えず攻膜蚴欷堡皮ており、今後も新しい攻膜..や攻磨末`ルを浠させ、@A的に攻膜蚴欷堡皮ることが考えられます。
今回の攻膜扦稀 .本の多くの企Iが.しているセキュリティ策u品の脆弱性が.されており、 .本のMを说膜趣筏皮い毪长趣わかります。说男凸膜纹鸬悚稀⑻砀顶榨ˉぅ毪浔 .にリンクを含むスピアフィッシングメ`ルが多いですが、 SSL VPNu品やル`タ.ゲ`トウェイu品の脆弱性を.するケ`スも多く、これらのu品の脆弱性を.されないためにも、 .々の脆弱性情螭喂芾恧刃拚パッチのm.や和策のm.などの早急な辘求められます。
オ`プンソ`スのポ`ト送／トンネリングツ`ルを.する说男凸膜俗⒁猡蓼俊これらの攻磨哎氅`プは、「 frp」や「 plink」といったポ`ト送／トンネリングツ`ルを.してリモ`トデスクトップ（RDP）接Aを.う攻膜.うことも_Jしています。ポ`ト送／トンネリングツ`ルを.した RDPを利.した攻膜卧については「オ`プンソ`スのポ`ト送／トンネリングツ`ルを.する说男凸膜俗⒁狻工 LAC WATCHをご参照ください。
ラックの{威分析チ`ムでは、今後もこの攻恼撺哎氅`プについて@A的に{摔贰冥情螭蛱峁─筏皮いますので、ご活.いただければ幸いです。 
MITRE ATT&CK Techniques 

18メモリ上にロ`ドされる DLLファイル名
以下に、 PoshC2を.した说男凸膜.いられる攻膜..をまとめます。これらの ..は、 MITRE ATT＆CKフレ`ム`クに基づいて作成しています。 Tacticの「 Lateral Movement」、「 Collection」、「 Command and Control」、「 Ex.ltration」の.については、多くが Mitre社のPoshC2でB介※18されるテクニックが利.されています。 
※18 
PoshC2, 
Software 
S0378 
| 
MITRE 
ATT&CK. 

表2 MITRE ATT&CK Techniques 
Tactic ID Name概要 
Initial T1195 Supply Chainセキュリティ策u品の脆弱性を.韦 Access Compromiseアップデ`トファイル配信
Execu\T1059 Command-Line regコマンドを利.したRDPO定涓やバ tion Interfaceッチファイルのg. 
T1086 PowerShell PoshC2スクリプトのg. 
T1035 Service RasAutoサ`ビスを利.したPoshC2スク Executionリプトのg. 
T1047 Scheduled Taskスケジュ`ルタスクを利.したPoshC2スクリプトのg. 
T1127 Trusted Develop\MSBuild. er Utilities 
Persis\T1031 Modify Existing RasAutoサ`ビスの涓 tence Service 
T1050 New Serviceサ`ビスの登h
T1060 Registry Run .悠婴违欹弗攻去曜芳 Keys / StartupFolder 
T1015 Accessibility.RC能を.したcmd.exeによるバッ Featuresクドア
De\T1038 DLL Search Or\正のg.ファイルが使うDLLファイルと fense der Hijacking
Eva\同じ名前の性ファイルを同.ディレクト sionリにO置
T1089 Disabling Securi\PowerShellスクリプトブロックのログh ty Toolsをo俊AMSIの回避
T1140 Deobfuscate/De\マルウェア内またはペイロ`ドに含まれる code Files or 
Information .字列をyi化
T1107 File Deletion使.したファイルの削除
T1055 Process Injection正プログラム（msbuild.exe, notepad.exeなど）にインジェクション
Tactic ID Name概要
Cre-dential Access  T1003  Credential Dumping  Poweshellを利.したMimikatzのg.  
Discov-ery  T1135  Network Share Discovery  netコマンドを利.したネットワ索  `クの探 
T1082  System Informa-tion Discovery  dirコマンドによるファイル仕  
T1049  System NetworkConnection Discovery  netstatコマンドによる通信しているIPアドレス.ポ`ト番号や解放ポ`トを表示  
T1057  Process Discovery  tasklistコマンドによるプロセス.E情螭蛉〉  
Lateral Move-ment  T1076 T1021  Remote DesktopProtocol Remote Services  frpや攻恼叨.のトンネリングツ`ルを利 .した外部からのRDP接A Plinkを利.した外部からのRDP接A  

T1021 Remote File PoshC2を利.したファイルのアップロ` Copyドまたはダウンロ`ド 
IOC（Indicator Of Compromised）
ハッシュ
7658d4c74b519187b2829359a921e374 f0fdb786ca994342a8a91adb5ba6987f
通信先
account[.]azure-microsoft[.]top 13[.]78[.]10[.]244 


